<!doctype html>
<html>
  <title>json server test</title>
  <head>
    <!-- 
      html template - thanks, past me!
      https://github.com/YoinkBird/bilderapp/blob/8a146512d981837ec062158bc4c2b9833c4c5a9c/templates/map_slider_img.html
    -->
    <!-- <json_server_api> -->
    <script type="text/javascript">
"use strict";
/*
  src: https://stackoverflow.com/a/24468752
  for send, receive . is usuing async, doesn't mention it though
  src: https://stackoverflow.com/a/4033310
  another style, better varnames, explicit mention of async
 */
// URL for JSON host 
var urlJsonServer = "http://localhost:8009";
/* send json */
function setVarAndLog(xhr){
  // callback(xhr.responseText);
  var jsonresp = JSON.parse(xhr.responseText);
  console.log('--- POST response received');
  console.log(JSON.stringify(jsonresp));
}
function httpPostAsync(myUrl, sendString, callback){
  var xhr_post = new XMLHttpRequest();
  xhr_post.open("POST",myUrl,true); // true : async
  xhr_post.setRequestHeader("Content-type", "application/json");
  // async - see the second source
  xhr_post.onreadystatechange = function (){
    if (xhr_post.readyState == 4 && xhr_post.status == 200){
      callback(xhr_post);
    }
  };
  xhr_post.send(sendString);
}
console.log('--- POST request sending');
// TODO: verify response. this particular server returns the same json_str it received
httpPostAsync(urlJsonServer, JSON.stringify({"lol":"hey"}), setVarAndLog);

console.log('--- POST request sent');

/* receive json */
/* TODO: async this thingy, forgot how to callbacks though.
 * current method may already be using a callback to set the var.
 */

// async notes:
// assigned before request complete
// var muhjaysawns = JSON.stringify(xhr_get.responseText);
// printed out either before request complete, or then before assigned
// console.log(JSON.stringify(muhjaysawns));
var muhjaysawns;

function setJsonVarAndLog(xhr){
  muhjaysawns = JSON.parse(xhr.responseText);
  if(1){
    console.log('--- GET response received');
    console.log(JSON.stringify(muhjaysawns));
  }
}

function httpGetAsync(myUrl, callback){
  var xhr_get  = new XMLHttpRequest();
  xhr_get.open("GET",myUrl,true);
  xhr_get.setRequestHeader("Content-type", "application/json");
  // async
  xhr_get.onreadystatechange = function (){
    if (xhr_get.readyState == 4 && xhr_get.status == 200){
      callback(xhr_get);
    }
  };
  xhr_get.send(null);
}

console.log('--- GET request sending');
// this url is a simple single-serving for now. no REST API
httpGetAsync(urlJsonServer, setJsonVarAndLog);
console.log('--- GET request sent');

// blocking
if(0){
  xhr.open("GET",urlJsonServer, false); // false for synchro
  console.log('--- blocking GET request sending');
  xhr.send(null);
  console.log('--- blocking GET request sent');
  var muhjaysawns = JSON.stringify(xhr.responseText);
  console.log(JSON.stringify(muhjaysawns));
}

console.log('--- --- ---');
    </script>
    <!-- </json_server_api> -->
  </head>
</html>
